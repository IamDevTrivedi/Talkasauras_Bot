name: talkasauras-prod

services:
    nginx:
        image: nginx:alpine
        container_name: talkasauras-prod-nginx
        restart: unless-stopped
        ports:
            - "5004:8080"
        volumes:
            - ./nginx.conf:/etc/nginx/nginx.conf:ro
        depends_on:
            - bot
            - redis-commander

    bot:
        build:
            context: .
            dockerfile: Dockerfile
        container_name: talkasauras-prod-bot
        restart: unless-stopped
        expose:
            - "5000"
        environment:
            - NODE_ENV=production
        env_file:
            - path: .env.production
              required: false
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
        sysctls:
            - net.ipv6.conf.all.disable_ipv6=1

    redis:
        image: redis:8-alpine
        container_name: talkasauras-prod-redis
        command: ["sh", "-c", "redis-server --requirepass $$REDIS_PASSWORD"]
        restart: unless-stopped
        env_file:
            - path: .env.production
              required: false
        volumes:
            - redis-data:/data
        healthcheck:
            test: ["CMD-SHELL", "redis-cli -a $$REDIS_PASSWORD ping"]
            interval: 5s
            timeout: 3s
            retries: 5
            start_period: 5s

    redis-commander:
        image: rediscommander/redis-commander:latest
        container_name: talkasauras-prod-redis-ui
        restart: unless-stopped
        environment:
            - REDIS_HOSTS=local:redis:6379
            - PORT=8081
        env_file:
            - path: .env.production
              required: false
        expose:
            - "8081"
        depends_on:
            redis:
                condition: service_healthy

    postgres:
        image: postgres:18-alpine
        container_name: talkasauras-prod-postgres
        restart: unless-stopped
        env_file:
            - path: .env.production
              required: false
        volumes:
            - postgres-data:/var/lib/postgresql/18/docker
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER"]
            interval: 5s
            timeout: 5s
            retries: 5
            start_period: 10s

    pgadmin:
        image: dpage/pgadmin4:latest
        container_name: talkasauras-prod-pgadmin
        restart: unless-stopped
        env_file:
            - path: .env.production
              required: false
        volumes:
            - pgadmin-data:/var/lib/pgadmin
        depends_on:
            postgres:
                condition: service_healthy

volumes:
    redis-data:
    postgres-data:
    pgadmin-data:
